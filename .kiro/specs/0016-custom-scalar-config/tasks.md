# Implementation Plan

## Task 1. 設定型定義と defineConfig API の実装

- [x] 1.1 (P) 設定ファイルの型定義を実装する
  - カスタムスカラーマッピングを定義するための設定型を作成する
  - スカラーマッピング設定には GraphQL スカラー名と TypeScript 型情報（インポートパスと型名）を含める
  - 複数のスカラーマッピングを配列で定義できる構造にする
  - CLI パッケージのエクスポートとして公開する
  - _Requirements: 2.1, 2.2, 2.4, 5.1, 5.2_

- [x] 1.2 (P) 型安全な設定ヘルパー関数を実装する
  - 設定オブジェクトを作成するためのヘルパー関数を提供する
  - TypeScript の型推論を活用して IDE での補完を有効にする
  - 関数は入力をそのまま返すシンプルな実装とする
  - CLI パッケージのエクスポートとして公開する
  - _Requirements: 5.3, 5.4_

## Task 2. 設定ファイルローダーの実装

- [x] 2. (P) 設定ファイルローダーを実装する
  - jiti を使用して TypeScript 設定ファイルを動的に読み込む
  - プロジェクトルートの `gqlkit.config.ts` を自動認識する
  - 設定ファイルが存在しない場合はデフォルト設定を返す
  - 構文エラー時は詳細なエラー情報を診断メッセージとして返す
  - ESM/CJS 両方の形式に対応する
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

## Task 3. 設定バリデーターの実装

- [x] 3. 設定オブジェクトのバリデーターを実装する
  - 設定オブジェクトの必須プロパティを検証する
  - 各プロパティの型が正しいことを検証する
  - GraphQL 組み込みスカラー名（ID, String, Int, Float, Boolean）の上書きを禁止する
  - 同一の GraphQL スカラー名に対する重複マッピングを検出する
  - 同一の TypeScript 型（型名+インポートパスのペア）に対する重複マッピングを検出する
  - エラー発生時は具体的なプロパティ名と期待される値を含む診断メッセージを返す
  - Task 2 のローダー実装が前提
  - _Requirements: 3.4, 4.1, 4.2, 4.4_

## Task 4. ScalarRegistry のカスタムスカラー対応拡張

- [x] 4. (P) ScalarRegistry をファクトリパターンで再構築する
  - 標準 branded type マッピングとカスタムマッピングを統合管理できるようにする
  - ファクトリ関数でレジストリインスタンスを作成する
  - TypeScript の `ts.resolveModuleName` API を使用してインポートパスを正規化する
  - 設定ファイルのディレクトリパスを基準として相対パスを解決する
  - 同一モジュールへの異なるパス表記（例: `./src/scalars` と `./src/scalars/index.ts`）を同一として扱う
  - インポートパスと型名のペアでマッピングを特定できるようにする
  - 登録済みカスタムスカラー名の一覧を取得できるようにする
  - 既存の標準 branded type マッピング（IDString, IDNumber, Int, Float）との後方互換性を維持する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.3_

## Task 5. BrandedDetector のカスタムスカラー検出拡張

- [x] 5. カスタム branded type の検出機能を追加する
  - ScalarRegistry を参照してカスタムスカラーを検出できるようにする
  - 設定で指定されたインポートパスからの型参照を認識する
  - カスタムスカラーの型が見つからない場合は警告を出力する
  - 標準 branded type とカスタムスカラーの両方を統一的に処理する
  - Task 4 の ScalarRegistry 拡張が前提
  - _Requirements: 2.3, 4.3_

## Task 6. ASTBuilder のカスタムスカラー定義生成拡張

- [x] 6. (P) カスタムスカラー定義の生成機能を追加する
  - ScalarRegistry から登録済みカスタムスカラー名を取得する
  - 各カスタムスカラーに対して GraphQL scalar 定義ノードを生成する
  - 生成した scalar 定義を typeDefs に含める
  - フィールド型としてカスタムスカラー名を正しく使用する
  - Task 4 の ScalarRegistry 拡張が前提
  - _Requirements: 3.1, 3.2_

## Task 7. gen コマンドへの統合

- [x] 7. gen コマンドに設定読み込みを統合する
  - コマンド実行開始時に設定ファイルを読み込む
  - 読み込んだ設定をバリデーションし、エラー時は終了する
  - 設定から ScalarRegistry を初期化する
  - 設定ファイルのディレクトリを基準として相対パスを解決する
  - ScalarRegistry をパイプライン全体で使用できるようにする
  - 設定ファイル不在時はデフォルト動作を継続する
  - Tasks 2, 3, 4 の完了が前提
  - _Requirements: 1.1, 1.2, 1.3_

## Task 8. 統合テストと E2E テスト

- [x] 8.1 設定読み込みからスキーマ生成までの統合テストを実装する
  - 設定ファイルを使用した完全なパイプラインの動作を検証する
  - カスタムスカラーを含む型定義が正しくスキーマに反映されることを確認する
  - 標準 branded type とカスタムスカラーの共存を検証する
  - _Requirements: 1.1, 2.3, 3.1, 3.2, 3.3_

- [x] 8.2 エラー診断の E2E テストを実装する
  - 設定ファイルの構文エラー時のメッセージを検証する
  - 必須プロパティ欠落時のエラーメッセージを検証する
  - 組み込みスカラー上書き時のエラーメッセージを検証する
  - 重複マッピング時のエラーメッセージを検証する
  - カスタムスカラー型が見つからない場合の警告を検証する
  - _Requirements: 1.3, 3.4, 4.1, 4.2, 4.3, 4.4_
